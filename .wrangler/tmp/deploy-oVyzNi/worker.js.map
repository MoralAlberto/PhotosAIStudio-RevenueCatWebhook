{
  "version": 3,
  "sources": ["../../../worker.ts"],
  "sourceRoot": "/Users/home/Documents/MyApps/Photos AI Studio/Photos AI Studio RevenueCat Webhook/.wrangler/tmp/deploy-oVyzNi",
  "sourcesContent": ["import { ExecutionContext } from \"@cloudflare/workers-types\";\n\nexport interface Env {\n    REVENUECAT_WEBHOOK_AUTH_TOKEN: string;\n    SUPABASE_KEY: string;\n    SUPABASE_URL: string;\n}\n\n// Definir la jerarqu\u00EDa de planes\nconst PLAN_HIERARCHY = {\n  'subscribe.photos_ai_studio.1week_basic': 1,\n  'subscribe.photos_ai_studio.1week_starter': 2,\n  'subscribe.photos_ai_studio.1week_pro': 3,\n  'subscribe.photos_ai_studio.1week_premium': 4\n} as const;\n\ntype PlanId = keyof typeof PLAN_HIERARCHY;\n\nfunction isUpgrade(currentPlan: string, newPlan: string): boolean {\n  return (PLAN_HIERARCHY[newPlan as PlanId] || 0) > (PLAN_HIERARCHY[currentPlan as PlanId] || 0);\n}\n\n// A\u00F1adir precios base para c\u00E1lculos\nconst BASE_PRICES = {\n  'subscribe.photos_ai_studio.1week_basic': 6.99,\n  'subscribe.photos_ai_studio.1week_starter': 9.99,\n  'subscribe.photos_ai_studio.1week_pro': 17.99,\n  'subscribe.photos_ai_studio.1week_premium': 24.99\n} as const;\n\n// Funci\u00F3n para calcular cr\u00E9ditos ajustados\nfunction calculateAdjustedCredits(baseCredits: number, paidPrice: number, productId: string): number {\n  console.log(`[calculateAdjustedCredits] Starting calculation for product: ${productId}`);\n  console.log(`[calculateAdjustedCredits] Base credits: ${baseCredits}`);\n  console.log(`[calculateAdjustedCredits] Paid price: ${paidPrice}`);\n  \n  const basePrice = BASE_PRICES[productId as keyof typeof BASE_PRICES] || 0;\n  console.log(`[calculateAdjustedCredits] Base price for product: ${basePrice}`);\n  \n  if (!basePrice) {\n    console.log(`[calculateAdjustedCredits] No base price found, returning original credits: ${baseCredits}`);\n    return baseCredits;\n  }\n  \n  const priceRatio = paidPrice / basePrice;\n  console.log(`[calculateAdjustedCredits] Price ratio: ${priceRatio}`);\n  \n  const result = Math.ceil(baseCredits * priceRatio);\n  console.log(`[calculateAdjustedCredits] Final adjusted credits: ${result}`);\n  return result;\n}\n\nexport default {\n  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {\n    return handleWebhook(request, env);\n  }\n};\n\nasync function handleWebhook(request: Request, env: Env): Promise<Response> {\n  console.log(\"[handleWebhook] Starting webhook processing\");\n\n  const authHeader = request.headers.get('Authorization');\n  if (!env.REVENUECAT_WEBHOOK_AUTH_TOKEN || authHeader !== `${env.REVENUECAT_WEBHOOK_AUTH_TOKEN}`) {\n    console.error(\"[handleWebhook] Token de autenticaci\u00F3n inv\u00E1lido\");\n    return new Response('Unauthorized', { status: 401 });\n  }\n\n  try {\n    const event = await request.json();\n    console.log('[handleWebhook] Event received:', JSON.stringify(event));\n\n    switch (event.event.type) {\n      case 'INITIAL_PURCHASE':\n      case 'RENEWAL':\n      case 'NON_RENEWING_PURCHASE':\n        console.log(`[handleWebhook] Processing standard purchase event: ${event.event.type}`);\n        await handlePurchaseEvent(event, env);\n        break;\n      case 'PRODUCT_CHANGE':\n        console.log(`[handleWebhook] Processing product change event`);\n        await handleProductChangeEvent(event, env);\n        break;\n      case 'CANCELLATION':\n      case 'EXPIRATION':\n        console.log(`[handleWebhook] Received cancellation or expiration: ${event.event.type}`);\n        break;\n      default:\n        console.log(`[handleWebhook] Unhandled event type: ${event.event.type}`);\n    }\n\n    return new Response('OK', { status: 200 });\n  } catch (error) {\n    console.error('[handleWebhook] Error processing webhook:', error);\n    return new Response('Internal Server Error', { status: 500 });\n  }\n}\n\nasync function handleProductChangeEvent(event: any, env: Env): Promise<void> {\n  console.log('[handleProductChangeEvent] Full event data:', JSON.stringify(event.event, null, 2));\n  \n  if (event.event.expiration_at_ms < event.event.event_timestamp_ms) {\n    console.log(`[handleProductChangeEvent] Skipping due to timing:\n      expiration_at_ms: ${event.event.expiration_at_ms}\n      event_timestamp_ms: ${event.event.event_timestamp_ms}\n      difference: ${event.event.expiration_at_ms - event.event.event_timestamp_ms}ms`);\n    return;\n  }\n  \n  const currentPlan = event.event.product_id;\n  const newPlan = event.event.new_product_id;\n  const userId = event.event.app_user_id;\n  const transactionId = event.event.id;\n  const expirationDate = new Date(event.event.expiration_at_ms).toISOString().split('T')[0];\n  const paidPrice = event.event.price_in_purchased_currency || 0;\n\n  console.log(`[handleProductChangeEvent] Processing change:\n    From: ${currentPlan}\n    To: ${newPlan}\n    User: ${userId}\n    Paid Price: ${paidPrice}\n    Expiration: ${expirationDate}`);\n\n  if (isUpgrade(currentPlan, newPlan)) {\n    console.log('[handleProductChangeEvent] Confirmed as upgrade');\n    const { coinAmount, numberOfModels } = getProductDetails(newPlan);\n    console.log(`[handleProductChangeEvent] Base plan details:\n      Base Coins: ${coinAmount}\n      Models: ${numberOfModels}`);\n      \n    const adjustedCoins = calculateAdjustedCredits(coinAmount, paidPrice, newPlan);\n    console.log(`[handleProductChangeEvent] After adjustment:\n      Original coins: ${coinAmount}\n      Adjusted coins: ${adjustedCoins}\n      Difference: ${adjustedCoins - coinAmount}`);\n    \n    await updateUserCredits(\n      userId,\n      transactionId,\n      adjustedCoins,\n      numberOfModels,\n      newPlan,\n      expirationDate,\n      false,\n      false,\n      env,\n      true\n    );\n  } else {\n    console.log('[handleProductChangeEvent] Processing as downgrade');\n    const { coinAmount, numberOfModels } = getProductDetails(newPlan);\n    await updateUserCredits(\n      userId,\n      transactionId,\n      coinAmount,\n      numberOfModels,\n      newPlan,\n      expirationDate,\n      false,\n      false,\n      env,\n      false\n    );\n  }\n}\n\nfunction getProductDetails(productId: string): { coinAmount: number, numberOfModels: number, isConsumable: boolean } {\n  const productDetails: { [key: string]: { coinAmount: number, numberOfModels: number, isConsumable: boolean } } = {\n    'subscribe.photos_ai_studio.1week_basic': { coinAmount: 20, numberOfModels: 1, isConsumable: false },\n    'subscribe.photos_ai_studio.1week_starter': { coinAmount: 50, numberOfModels: 1, isConsumable: false },\n    'subscribe.photos_ai_studio.1week_pro': { coinAmount: 100, numberOfModels: 2, isConsumable: false },\n    'subscribe.photos_ai_studio.1week_premium': { coinAmount: 250, numberOfModels: 3, isConsumable: false },\n    'photosai.credits.100': { coinAmount: 100, numberOfModels: 0, isConsumable: true }\n  };\n  return productDetails[productId] || { coinAmount: 0, numberOfModels: 0, isConsumable: false };\n}\n\nasync function handlePurchaseEvent(event: any, env: Env): Promise<void> {\n  const userId = event.event.app_user_id;\n  const transactionId = event.event.id;\n  const isRenewal = event.event.type === 'RENEWAL';\n  const paidPrice = event.event.price_in_purchased_currency || 0;\n\n  const effectiveProductId = event.event.new_product_id || event.event.product_id;\n  const expirationDate = new Date(event.event.expiration_at_ms).toISOString().split('T')[0];\n\n  console.log(`[handlePurchaseEvent] Processing purchase for product: ${effectiveProductId}`);\n\n  const { coinAmount, numberOfModels, isConsumable } = getProductDetails(effectiveProductId);\n  const adjustedCoins = isConsumable ? coinAmount : calculateAdjustedCredits(coinAmount, paidPrice, effectiveProductId);\n  \n  await updateUserCredits(\n    userId,\n    transactionId,\n    adjustedCoins,\n    numberOfModels,\n    effectiveProductId,\n    expirationDate,\n    isConsumable,\n    isRenewal,\n    env,\n    false\n  );\n}\n\nasync function updateUserCredits(\n  userId: string, \n  transactionId: string, \n  coinAmount: number, \n  numberOfModels: number, \n  productId: string,\n  expirationDate: string,\n  isConsumable: boolean,\n  isRenewal: boolean,\n  env: Env,\n  isUpgrade: boolean\n): Promise<void> {\n  console.log(`[updateUserCredits] Processing update:\n    User: ${userId}\n    Transaction: ${transactionId}\n    Coins: ${coinAmount}\n    Models: ${numberOfModels}\n    Product: ${productId}\n    Is Upgrade: ${isUpgrade}\n    Is Renewal: ${isRenewal}\n    Is Consumable: ${isConsumable}`);\n\n  if (!isValidUUID(userId)) {\n    console.error('[updateUserCredits] Invalid UUID:', userId);\n    throw new Error('User ID no es un UUID v\u00E1lido');\n  }\n\n  try {\n    const requestBody = {\n      p_user_id: userId,\n      p_transaction_id: transactionId,\n      p_coin_amount: coinAmount,\n      p_models: numberOfModels,\n      p_product_id: productId,\n      p_expiration_date: expirationDate,\n      p_is_consumable: isConsumable,\n      p_is_renewal: isRenewal\n    };\n    \n    console.log('[updateUserCredits] Sending request to Supabase:', JSON.stringify(requestBody, null, 2));\n\n    const response = await fetch(`${env.SUPABASE_URL}/rest/v1/rpc/process_transaction`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'apikey': env.SUPABASE_KEY,\n        'Authorization': `Bearer ${env.SUPABASE_KEY}`\n      },\n      body: JSON.stringify(requestBody)\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('[updateUserCredits] Supabase error response:', errorText);\n      throw new Error(`Error al actualizar los cr\u00E9ditos del usuario: ${errorText}`);\n    }\n\n    const result = await response.json();\n    console.log('[updateUserCredits] Success! Result:', JSON.stringify(result, null, 2));\n  } catch (error) {\n    console.error('[updateUserCredits] Error details:', error);\n    throw error;\n  }\n}\n\nfunction isValidUUID(uuid: string): boolean {\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(uuid);\n}"],
  "mappings": ";AASA,IAAM,iBAAiB;AAAA,EACrB,0CAA0C;AAAA,EAC1C,4CAA4C;AAAA,EAC5C,wCAAwC;AAAA,EACxC,4CAA4C;AAC9C;AAIA,SAAS,UAAU,aAAqB,SAA0B;AAChE,UAAQ,eAAe,OAAiB,KAAK,MAAM,eAAe,WAAqB,KAAK;AAC9F;AAGA,IAAM,cAAc;AAAA,EAClB,0CAA0C;AAAA,EAC1C,4CAA4C;AAAA,EAC5C,wCAAwC;AAAA,EACxC,4CAA4C;AAC9C;AAGA,SAAS,yBAAyB,aAAqB,WAAmB,WAA2B;AACnG,UAAQ,IAAI,gEAAgE,WAAW;AACvF,UAAQ,IAAI,4CAA4C,aAAa;AACrE,UAAQ,IAAI,0CAA0C,WAAW;AAEjE,QAAM,YAAY,YAAY,SAAqC,KAAK;AACxE,UAAQ,IAAI,sDAAsD,WAAW;AAE7E,MAAI,CAAC,WAAW;AACd,YAAQ,IAAI,+EAA+E,aAAa;AACxG,WAAO;AAAA,EACT;AAEA,QAAM,aAAa,YAAY;AAC/B,UAAQ,IAAI,2CAA2C,YAAY;AAEnE,QAAM,SAAS,KAAK,KAAK,cAAc,UAAU;AACjD,UAAQ,IAAI,sDAAsD,QAAQ;AAC1E,SAAO;AACT;AAEA,IAAO,iBAAQ;AAAA,EACb,MAAM,MAAM,SAAkB,KAAU,KAA0C;AAChF,WAAO,cAAc,SAAS,GAAG;AAAA,EACnC;AACF;AAEA,eAAe,cAAc,SAAkB,KAA6B;AAC1E,UAAQ,IAAI,6CAA6C;AAEzD,QAAM,aAAa,QAAQ,QAAQ,IAAI,eAAe;AACtD,MAAI,CAAC,IAAI,iCAAiC,eAAe,GAAG,IAAI,iCAAiC;AAC/F,YAAQ,MAAM,uDAAiD;AAC/D,WAAO,IAAI,SAAS,gBAAgB,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,MAAI;AACF,UAAM,QAAQ,MAAM,QAAQ,KAAK;AACjC,YAAQ,IAAI,mCAAmC,KAAK,UAAU,KAAK,CAAC;AAEpE,YAAQ,MAAM,MAAM,MAAM;AAAA,MACxB,KAAK;AAAA,MACL,KAAK;AAAA,MACL,KAAK;AACH,gBAAQ,IAAI,uDAAuD,MAAM,MAAM,MAAM;AACrF,cAAM,oBAAoB,OAAO,GAAG;AACpC;AAAA,MACF,KAAK;AACH,gBAAQ,IAAI,iDAAiD;AAC7D,cAAM,yBAAyB,OAAO,GAAG;AACzC;AAAA,MACF,KAAK;AAAA,MACL,KAAK;AACH,gBAAQ,IAAI,wDAAwD,MAAM,MAAM,MAAM;AACtF;AAAA,MACF;AACE,gBAAQ,IAAI,yCAAyC,MAAM,MAAM,MAAM;AAAA,IAC3E;AAEA,WAAO,IAAI,SAAS,MAAM,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3C,SAAS,OAAP;AACA,YAAQ,MAAM,6CAA6C,KAAK;AAChE,WAAO,IAAI,SAAS,yBAAyB,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9D;AACF;AAEA,eAAe,yBAAyB,OAAY,KAAyB;AAC3E,UAAQ,IAAI,+CAA+C,KAAK,UAAU,MAAM,OAAO,MAAM,CAAC,CAAC;AAE/F,MAAI,MAAM,MAAM,mBAAmB,MAAM,MAAM,oBAAoB;AACjE,YAAQ,IAAI;AAAA,0BACU,MAAM,MAAM;AAAA,4BACV,MAAM,MAAM;AAAA,oBACpB,MAAM,MAAM,mBAAmB,MAAM,MAAM,sBAAsB;AACjF;AAAA,EACF;AAEA,QAAM,cAAc,MAAM,MAAM;AAChC,QAAM,UAAU,MAAM,MAAM;AAC5B,QAAM,SAAS,MAAM,MAAM;AAC3B,QAAM,gBAAgB,MAAM,MAAM;AAClC,QAAM,iBAAiB,IAAI,KAAK,MAAM,MAAM,gBAAgB,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AACxF,QAAM,YAAY,MAAM,MAAM,+BAA+B;AAE7D,UAAQ,IAAI;AAAA,YACF;AAAA,UACF;AAAA,YACE;AAAA,kBACM;AAAA,kBACA,gBAAgB;AAEhC,MAAI,UAAU,aAAa,OAAO,GAAG;AACnC,YAAQ,IAAI,iDAAiD;AAC7D,UAAM,EAAE,YAAY,eAAe,IAAI,kBAAkB,OAAO;AAChE,YAAQ,IAAI;AAAA,oBACI;AAAA,gBACJ,gBAAgB;AAE5B,UAAM,gBAAgB,yBAAyB,YAAY,WAAW,OAAO;AAC7E,YAAQ,IAAI;AAAA,wBACQ;AAAA,wBACA;AAAA,oBACJ,gBAAgB,YAAY;AAE5C,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF,OAAO;AACL,YAAQ,IAAI,oDAAoD;AAChE,UAAM,EAAE,YAAY,eAAe,IAAI,kBAAkB,OAAO;AAChE,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;AAEA,SAAS,kBAAkB,WAA0F;AACnH,QAAM,iBAA2G;AAAA,IAC/G,0CAA0C,EAAE,YAAY,IAAI,gBAAgB,GAAG,cAAc,MAAM;AAAA,IACnG,4CAA4C,EAAE,YAAY,IAAI,gBAAgB,GAAG,cAAc,MAAM;AAAA,IACrG,wCAAwC,EAAE,YAAY,KAAK,gBAAgB,GAAG,cAAc,MAAM;AAAA,IAClG,4CAA4C,EAAE,YAAY,KAAK,gBAAgB,GAAG,cAAc,MAAM;AAAA,IACtG,wBAAwB,EAAE,YAAY,KAAK,gBAAgB,GAAG,cAAc,KAAK;AAAA,EACnF;AACA,SAAO,eAAe,SAAS,KAAK,EAAE,YAAY,GAAG,gBAAgB,GAAG,cAAc,MAAM;AAC9F;AAEA,eAAe,oBAAoB,OAAY,KAAyB;AACtE,QAAM,SAAS,MAAM,MAAM;AAC3B,QAAM,gBAAgB,MAAM,MAAM;AAClC,QAAM,YAAY,MAAM,MAAM,SAAS;AACvC,QAAM,YAAY,MAAM,MAAM,+BAA+B;AAE7D,QAAM,qBAAqB,MAAM,MAAM,kBAAkB,MAAM,MAAM;AACrE,QAAM,iBAAiB,IAAI,KAAK,MAAM,MAAM,gBAAgB,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAExF,UAAQ,IAAI,0DAA0D,oBAAoB;AAE1F,QAAM,EAAE,YAAY,gBAAgB,aAAa,IAAI,kBAAkB,kBAAkB;AACzF,QAAM,gBAAgB,eAAe,aAAa,yBAAyB,YAAY,WAAW,kBAAkB;AAEpH,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;AAEA,eAAe,kBACb,QACA,eACA,YACA,gBACA,WACA,gBACA,cACA,WACA,KACAA,YACe;AACf,UAAQ,IAAI;AAAA,YACF;AAAA,mBACO;AAAA,aACN;AAAA,cACC;AAAA,eACC;AAAA,kBACGA;AAAA,kBACA;AAAA,qBACG,cAAc;AAEjC,MAAI,CAAC,YAAY,MAAM,GAAG;AACxB,YAAQ,MAAM,qCAAqC,MAAM;AACzD,UAAM,IAAI,MAAM,iCAA8B;AAAA,EAChD;AAEA,MAAI;AACF,UAAM,cAAc;AAAA,MAClB,WAAW;AAAA,MACX,kBAAkB;AAAA,MAClB,eAAe;AAAA,MACf,UAAU;AAAA,MACV,cAAc;AAAA,MACd,mBAAmB;AAAA,MACnB,iBAAiB;AAAA,MACjB,cAAc;AAAA,IAChB;AAEA,YAAQ,IAAI,oDAAoD,KAAK,UAAU,aAAa,MAAM,CAAC,CAAC;AAEpG,UAAM,WAAW,MAAM,MAAM,GAAG,IAAI,gDAAgD;AAAA,MAClF,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,UAAU,IAAI;AAAA,QACd,iBAAiB,UAAU,IAAI;AAAA,MACjC;AAAA,MACA,MAAM,KAAK,UAAU,WAAW;AAAA,IAClC,CAAC;AAED,QAAI,CAAC,SAAS,IAAI;AAChB,YAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAQ,MAAM,gDAAgD,SAAS;AACvE,YAAM,IAAI,MAAM,oDAAiD,WAAW;AAAA,IAC9E;AAEA,UAAM,SAAS,MAAM,SAAS,KAAK;AACnC,YAAQ,IAAI,wCAAwC,KAAK,UAAU,QAAQ,MAAM,CAAC,CAAC;AAAA,EACrF,SAAS,OAAP;AACA,YAAQ,MAAM,sCAAsC,KAAK;AACzD,UAAM;AAAA,EACR;AACF;AAEA,SAAS,YAAY,MAAuB;AAC1C,QAAM,YAAY;AAClB,SAAO,UAAU,KAAK,IAAI;AAC5B;",
  "names": ["isUpgrade"]
}
